<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>

    <div class='box'>
	    Below are the contracts you can cancel...
    </div>

 	<div class='contract'></div>

</body>
<script type="text/javascript" src='contract.js'></script>
<script src="https://cdn.rawgit.com/ethereum/web3.js/develop/dist/web3.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">

    async function listContracts() {
        var address = web3.eth.accounts[0]
        var contracts = await getContractList(address)
        for (var index in contracts){
            var contractData = await getContractData(contracts[index])
            if (contractData.length === 1 && Number(contractData[0].value) !== 0){
                
                var contractValue = contractData[0].value/1000000000000000000
                var contractAddress = contracts[index]
                $('.contract').append(`

                    <div id="${contractAddress}">
                        I agree to cancel
                        <br>
                        Contract: ${contractAddress}
                        <br>
                        then 
                        <br>
                        Get back: ${contractValue} ETH
                        <br>
                        <button onclick="cancelContract('${contractAddress}')"> cancel this transaction </button>
        				<br><br><hr><br>
                    </div>`

                )
            }
        }
    }

    function cancelContract(address){
        web3.eth.contract(contractAbi).at(address).abort({}, function(err, data){
        	var message = 'your transaction has been canceled. you will be refunded shortly'
		    document.getElementById(address).innerHTML = message
    	})
	}

    function getContractData(address){
        return new Promise (function(resolve){
            $.get(`https://rinkeby.etherscan.io/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999`, function (response) {
                var data = response.result
                resolve(data)
            })
        })
    }

    function getContractList(address){
        return new Promise (function(resolve){
            $.get(`https://rinkeby.etherscan.io/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999`, function (response) {
                var data = response.result
                var contracts = []
                for (var index in data){
                    var contractAddress = data[index].contractAddress
                    if (contractAddress !== ''){
                        contracts.push(contractAddress)
                    }
                }
                resolve(contracts.reverse())
            })
        })
    }

    window.addEventListener('load', function() {
        web3.version.getNetwork((err, netId) => {
            switch (netId) {
            case "1":
                console.log('This is mainnet')
                break
            case "2":
                console.log('This is the deprecated Morden test network.')
                break
            case "3":
                console.log('This is the ropsten test network.')
                break
            case "4":
                console.log('This is the rinkeby test network.')
                break
            default:
                alert('Please connect to Metamask or Mist then try again')
                return
            }
            listContracts()
        })
    })

</script>

</html>