<!DOCTYPE html>
<html>
<head>
	<title></title>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>

    <div class='box'>
        I agree to buy this item: 
        <br><br>
        The contract address is: <input id='buyContractAddress'></input>
        <br><br>
        The total amount of ETH is: <input type=number id='buyValue'></input>
        <br><br><hr><br>
        <button disabled onclick="buy()" id="btn"> buy </button>
    </div>

    <div class='message'> 
        Buy:
        <br><br>
        When you buy, the contract will hold your amount and the sellers amount until you recieve the item. When you recieve the item you must confirm.
        This tells the contract to release the funds and complete the transaction.
    </div>

    <div class='popup'></div>

</body>
<script type="text/javascript" src='common.js'></script>
<script type="text/javascript" src='contract.js'></script>
<script src="https://cdn.rawgit.com/ethereum/web3.js/develop/dist/web3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/4.1.0/bignumber.min.js"></script>
<script type="text/javascript">

    // creates a dynamic contract
    // https://ethereum-escrow.github.io/store/buy.html?val=0.4&addr=0xbe6714e8efea13ecf2a5b9bdbabe5fd67a98061b
    var url = parseURL(window.location.href)
    var contractAddress = url.searchObject.addr
    var buyValue = url.searchObject.val
    if (contractAddress !== undefined && buyValue !== undefined){
        document.getElementById('buyContractAddress').value = contractAddress
        document.getElementById('buyValue').value = buyValue
    }


    function buy() {

        // get value of contract
        web3.eth.contract(contractAbi).at(contractAddress).value.call({}, function (err, contractValue){
           
            var contractValue = new BigNumber(contractValue).toNumber()

            // the buyer must put 2x amount. 1x for the item. 1x as collateral. collaterall will be returned
            if (contractValue * 2 === Number(buyValue) * 1000000000000000000){

                // buy
                web3.eth.contract(contractAbi).at(contractAddress).confirmPurchase(
                    {
                        from: web3.eth.accounts[0], 
                        data: contractByteCode, 
                        gas: '4700000',
                        value: Number(buyValue) * 1000000000000000000
                    }, function(err, transactionAddress){

                    if (transactionAddress){
                        var message = `
                        your item has been purchased 
                        <br><br> 
                        https://rinkeby.etherscan.io/tx/${transactionAddress} 
                        <br><br> 
                        contact the seller to send the item
                        <br><br>
                        once you recieve your item, complete the transaction here:
                        <br><br>
                        https://ethereum-escrow.github.io/store/recieve.html?addr=${contractAddress}
                        `
                        document.getElementsByClassName('popup')[0].innerHTML = message
                    }
                })

            } else {
                alert('value does not match')
            }
        })
        
    }



	window.addEventListener('load', function() {
        // this function is in contract.js
        loadWeb3()
	})


</script>

</html>