<!DOCTYPE html>
<html>
<head>
	<title></title>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>

    <div class='box'>
        I agree to buy an item:.
        <br><br>
        The contract address is: <input id='buyContractAddress'></input>
        <br><br>
        The total amount of ETH is: <input type=number id='buyValue'></input>
        <br><br>
        <button onclick="buy()" id="btn"> buy </button>
        <br><br><hr><br>
        <!-- id sell displays the  message after a seller creates a contract-->
        <div id='buy'></div>
    </div>

    <div id='recieve'></div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/4.1.0/bignumber.min.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">

    'use strict'
    const contractAbi = [{"constant":true,"inputs":[],"name":"seller","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"abort","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"value","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"buyer","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"confirmReceived","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"confirmPurchase","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"inputs":[],"payable":true,"stateMutability":"payable","type":"constructor"},{"anonymous":false,"inputs":[],"name":"Aborted","type":"event"},{"anonymous":false,"inputs":[],"name":"PurchaseConfirmed","type":"event"},{"anonymous":false,"inputs":[],"name":"ItemReceived","type":"event"}]
    const contractByteCode = '606060405233600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503460008190555061064f8061005b6000396000f30060606040523615610081576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806308551a531461008657806335a063b4146100db5780633fa4f245146100f05780637150d8ae1461011957806373fac6f01461016e578063c19d93fb14610183578063d6960697146101ba575b600080fd5b341561009157600080fd5b6100996101c4565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156100e657600080fd5b6100ee6101ea565b005b34156100fb57600080fd5b610103610346565b6040518082815260200191505060405180910390f35b341561012457600080fd5b61012c61034c565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561017957600080fd5b610181610372565b005b341561018e57600080fd5b610196610532565b604051808260028111156101a657fe5b60ff16815260200191505060405180910390f35b6101c2610545565b005b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561024657600080fd5b600080600281111561025457fe5b600260149054906101000a900460ff16600281111561026f57fe5b14151561027b57600080fd5b7f72c874aeff0b183a56e2b79c71b46e1aed4dee5e09862134b8821ba2fddbf8bf60405160405180910390a160028060146101000a81548160ff021916908360028111156102c557fe5b0217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f19350505050151561034357600080fd5b50565b60005481565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156103ce57600080fd5b60018060028111156103dc57fe5b600260149054906101000a900460ff1660028111156103f757fe5b14151561040357600080fd5b7fe89152acd703c9d8c7d28829d443260b411454d45394e7995815140c8cbcbcf760405160405180910390a160028060146101000a81548160ff0219169083600281111561044d57fe5b0217905550600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6000549081150290604051600060405180830381858888f1935050505015156104b657600080fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f19350505050151561052f57600080fd5b50565b600260149054906101000a900460ff1681565b600080600281111561055357fe5b600260149054906101000a900460ff16600281111561056e57fe5b14151561057a57600080fd5b600054600202341480151561058e57600080fd5b7fd5d55c8a68912e9a110618df8d5e2e83b8d83211c57a8ddd1203df92885dc88160405160405180910390a133600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001600260146101000a81548160ff0219169083600281111561061a57fe5b021790555050505600a165627a7a72305820b61bee0062c31b867f0535f49adc84d62a019a72979e7b0058029fc76a58b98d0029'
    let etherscanLink
    window.addEventListener('load', async function() {
        etherscanLink = await getEtherscanLink()
        getBuyValue ()
        getContractValue()
        listContracts()
    })

    async function buy() {
        const buyValue = getBuyValue()
        const contractAddress = getContractAddress()
        const contractValue = await getContractValue()
        // if the buyer does NOT put 2x amount. (1x for the item. 1x as collateral) then try again
        if (contractValue * 2 !== Number(buyValue) * 1000000000000000000) {
            alert(`this item is worth ${contractValue * 2 / 1000000000000000000} ETH to buy`)
            return
        }
        // buy
        web3.eth.contract(contractAbi).at(contractAddress).confirmPurchase(
            {
                from: web3.eth.accounts[0],
                data: contractByteCode,
                gas: '4700000',
                value: Number(buyValue) * 1000000000000000000
            }, function(err, transactionAddress) {
                if (err){return}
                displayMessage(transactionAddress)
            })
    }

    function displayMessage (transactionAddress) {
        document.getElementById('buy').innerHTML =
            `
            your item has been purchased!
            <br><br>
            ${etherscanLink}tx/${transactionAddress}
            <br><br>
            contact the seller to send the item
            <br><br>
            once you recieve your item, complete the transaction here:
            <br><br>
            https://ethereum-escrow.github.io/store/buy.html
            `
    }

    function getBuyValue () {
        const url = parseURL(window.location.href)
        let buyValue = url.searchObject.val
        // if the link does not have "...buy.html?val=0.08..."
        if (buyValue === undefined){
            buyValue = document.getElementById('buyValue').value
        } else {
            document.getElementById('buyValue').value = buyValue
        }
        return buyValue
    }

    function getContractAddress () {
        const url = parseURL(window.location.href)
        let contractAddress = url.searchObject.addr
        if (contractAddress !== undefined){
            document.getElementById('buyContractAddress').value = contractAddress
        } else {
            contractAddress = document.getElementById('buyContractAddress').value
        }
        return contractAddress
    }

    function getContractValue () {
        const contractAddress = getContractAddress()
        return new Promise(resolve => {
            web3.eth.contract(contractAbi).at(contractAddress).value.call({}, function (err, contractValue) {
                resolve(new BigNumber(contractValue).toNumber())
            })
        })
    }

    function getEtherscanLink() {
        return new Promise(resolve => {
            // Checking if Web3 has been injected by the browser (Mist/MetaMask)
            if (typeof web3 === 'undefined') {
            alert('Please connect to Metamask or Mist then try again')
            return
        }
        web3.version.getNetwork((err, netId) => {
            switch (netId) {
            case "1":
                console.log('This is mainnet')
                resolve('https://etherscan.io/')
                break
            case "2":
                console.log('This is the deprecated Morden test network.')
                resolve('https://morden.etherscan.io/')
                break
            case "3":
                console.log('This is the ropsten test network.')
                resolve('https://ropsten.etherscan.io/')
                break
            case "4":
                console.log('This is the rinkeby test network.')
                resolve('https://rinkeby.etherscan.io/')
                break
            default:
                alert('Please connect to Metamask or Mist then try again')
            }
        })
    })
    }

    function parseURL(url) {
        var parser = document.createElement('a'),
            searchObject = {},
            queries, split, i;
        // Let the stack overflow do the work
        parser.href = url;
        // Convert query string to object
        queries = parser.search.replace(/^\?/, '').split('&');
        for( i = 0; i < queries.length; i++ ) {
            split = queries[i].split('=');
            searchObject[split[0]] = split[1];
        }
        return {
            protocol: parser.protocol,
            host: parser.host,
            hostname: parser.hostname,
            port: parser.port,
            pathname: parser.pathname,
            search: parser.search,
            searchObject: searchObject,
            hash: parser.hash
        };
    }

    async function listContracts() {
        var address = web3.eth.accounts[0]
        var contracts = await getContractList(address)
        for (var index in contracts){
            var contractData = await getContractData(contracts[index])
            if (contractData.length === 2 && Number(contractData[contractData.length-1].value) > 0){
                var contractValue = contractData[0].value/1000000000000000000
                var contractAddress = contracts[index]
                displayRecieveMessage(contractAddress)
            }
        }
    }

    function displayRecieveMessage(contractAddress){
        let oldListing = document.getElementById('recieve').innerHTML
        let newListing = `
            <div class="message" id="${contractAddress}">
                I recieved
                <br>
                Contract address: ${contractAddress}
                <br>
                <button onclick="recieve('${contractAddress}')"> Item Recieved </button>
            </div>
            `
        document.getElementById('recieve').innerHTML = oldListing + newListing
    }

    function recieve(address){
        web3.eth.contract(contractAbi).at(address).confirmReceived({}, function(err, data){
            if (err){return}
            document.getElementById(address).innerHTML =  `
                your transaction:
                <br>
                ${etherscanLink}address/${address}
                <br>
                has been completed.
                <br>
                You will be refunded shortly`
        })
    }

    function getContractData(address){
        return new Promise (function(resolve){
            $.get(`${etherscanLink}api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999`, function (response) {
                var data = response.result
                resolve(data)
            })
        })
    }

    function getContractList(address){
        return new Promise (function(resolve){
            $.get(`${etherscanLink}api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999`, function (response) {
                var data = response.result
                var contracts = []
                for (var index in data){
                    var contractAddress = data[index].to
                    contracts.push(contractAddress)
                }
                resolve(contracts.reverse())
            })
        })
    }

</script>

</html>